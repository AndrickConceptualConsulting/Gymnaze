rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Inquiries collection - allow creation for everyone, read/write for authenticated users only
    match /inquiries/{inquiryId} {
      // Anyone can create an inquiry (for the contact form)
      allow create: if true
                    && request.resource.data.keys().hasAll(['name', 'organization', 'role', 'email', 'numberOfAthletes', 'timestamp', 'status', 'source', 'id'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() >= 2
                    && request.resource.data.name.size() <= 50
                    && request.resource.data.organization is string
                    && request.resource.data.organization.size() >= 2
                    && request.resource.data.organization.size() <= 100
                    && request.resource.data.role is string
                    && request.resource.data.role.size() >= 2
                    && request.resource.data.role.size() <= 50
                    && request.resource.data.email is string
                    && request.resource.data.email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
                    && request.resource.data.numberOfAthletes is number
                    && request.resource.data.numberOfAthletes >= 1
                    && request.resource.data.numberOfAthletes <= 10000
                    && request.resource.data.status == 'new'
                    && request.resource.data.source == 'website_inquiry_form'
                    && request.resource.data.timestamp is timestamp;
      
      // Only authenticated users (admins) can read and update inquiries
      allow read, update: if request.auth != null;
      
      // No one can delete inquiries (for audit trail)
      allow delete: if false;
    }

    // Newsletter signups collection - allow creation for everyone, read/write for authenticated users only
    match /newsletter_signups/{signupId} {
      // Anyone can create a newsletter signup
      allow create: if true
                    && request.resource.data.keys().hasAll(['email', 'firstName', 'timestamp', 'status', 'source', 'id', 'subscribed'])
                    && request.resource.data.email is string
                    && request.resource.data.email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
                    && request.resource.data.firstName is string
                    && request.resource.data.firstName.size() >= 2
                    && request.resource.data.firstName.size() <= 30
                    && request.resource.data.status == 'active'
                    && request.resource.data.source == 'website_newsletter_form'
                    && request.resource.data.subscribed == true
                    && request.resource.data.timestamp is timestamp;
      
      // Allow updates for unsubscribe functionality (merge operations)
      allow update: if true
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['subscribed', 'unsubscribedAt', 'status'])
                    && request.resource.data.subscribed == false
                    && request.resource.data.status == 'unsubscribed';
      
      // Only authenticated users (admins) can read newsletter signups
      allow read: if request.auth != null;
      
      // No one can delete newsletter signups (for audit trail)
      allow delete: if false;
    }

    // Default rule: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
